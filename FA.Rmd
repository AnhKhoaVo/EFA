---
title: "FA"
author: "Anh Khoa Vo"
date: "November 9, 2017"
output:
  html_document: default
---


We have found that Albumin at week 4 is predictive of outcome - motor scores by week 52. However, I was wondering if a set of observed variables would have a better chance of predicting outcome than just one single variable. 

Exploratory Factor Analysis (EFA) has been used to explore the possible underlying factor structure of a set of observed variables without imposing a preconcieved structure on the outcome. By performing EFA, the underlying factor structure is identified. 

First, I upload the data set, and scale every variable in the dataset to reduce large variance between variable. I also remove two variables in the dataset since these two have the most missing data. (This led to several problems for my EFA later on) 

```{r, include=FALSE}
library(readxl)
cfa_week0 <- read_excel("C:/Users/Anh Khoa/Desktop/cfa-week0.xlsx")
View(cfa_week0)

cfa_week0$DAN00 <- NULL
cfa_week0$AMY00 <- NULL

str(cfa1_week0)

cfa1_week0 <- cbind(cfa_week0, Others)
cfa1_week0 <- cfa1_week0 %>% mutate_if(is.factor,as.numeric)
cfa1_week0 <- scale(cfa1_week0, center = TRUE, scale = TRUE)
cfa1_week0 <- data.frame(cfa1_week0)


```

To identify the correct number of factors to pick for analysis, we can visualize it using scree plot. 

```{r}
library(psych)
scree <- fa.parallel(cfa1_week0[-1:-3], fm = "ml", fa = "fa")
scree
```

To visualize the number of factors and the variables inside each factor 

```{r}
fa <- fa(cfa1_week0[-1], nfactors=6, rotate="varimax", fm="ml")
fa.diagram(fa)

print(fa$loadings, cutoff = 0.4)
```



```{r}
library(lavaan)
model0 <- 'Factor 1 =~ HGB00 + HCT00 + RBC00 
           Factor 2 =~ STP00 + ALB00 + CAB00
           Factor 3 =~ CK000 + ALT00 + AST00
           Factor 4 =~ BUN00 + BC900 + BUA00
           Factor 5 =~ MCV00 + MCH00
           Factor 6 =~ DDN00 + DBN00
           AST00 ~~ 0*AST00
           MCV00 ~~ 0*MCV00
           DDN00 ~~ 0*DDN00
           TLAMS52 ~ Factor 1 + Factor 2 + Factor 3 + Factor 4 + Factor 5 + Factor 6'

f1_week0 <- sem(model0, data = cfa1_week0, std.lv=TRUE, missing = "fiml")
summary(f1_week0, standardized = TRUE, fit.measures = TRUE)

```

The output comes out with a summary table. However, I am not quite sure what the internal statistics behind this function. Therefore, I'd prefer to analyse the data by mysel. Anyway, this is the graph to visualize the previous summary table: 

```{r}
library(semPlot)
semPaths(f1_week0,"std", whatLabels="std", intercepts=FALSE, style="lisrel", residuals = FALSE,
         nCharNodes=0, 
         nCharEdges=0,
         curveAdjacent = TRUE,title=TRUE, layout="tree2",curvePivot=FALSE)
```

Now, to run the analysis, I need to compute the estimated values for latent variables!!!! 

```{r, include=FALSE}
p_week0 <- lavPredict(f1_week0)
p_week0 <- as.data.frame(p_week0)
colnames(p_week0) <- c("Factor1_w0", "Factor2_w0", "Factor3_w0", "Factor4_w0", "Factor5_w0", "Factor6_w0")

```

And now, In order to see which factor is predictive of outcome, I run a simple linear regression: 
```{r, include=FALSE}
cfa2_week0 <- cbind(cfa1_week0, p_week0)
cfa2_week0
```


```{r}
factor_lm <- function(x) {
  f1 <- summary(lm(TLAMS52 ~ Factor1_w0, data = x))
  f2 <- summary(lm(TLAMS52 ~ Factor2_w0, data = x))
  f3 <- summary(lm(TLAMS52 ~ Factor3_w0, data = x))
  f4 <- summary(lm(TLAMS52 ~ Factor4_w0, data = x))
  f5 <- summary(lm(TLAMS52 ~ Factor5_w0, data = x))
  f6 <- summary(lm(TLAMS52 ~ Factor6_w0, data = x))
  f7 <- summary(lm(TLAMS52 ~ CHC00, data=x))
  return(list(f1,f2,f3,f4,f5,f6,f7))
}

factor_lm(cfa2_week0)
```





BUT, we know 2 factors signifcantly correlated to outcome but, how about each variable made up of that factor? Does each of them correlate stronger to outcome too??


```{r}
library(knitr)
clusters <- c("Factor1_w0", "Factor2_w0", "Factor3_w0", "TLAMS52", "RBC00", "HGB00", "HCT00", "STP00", "ALB00", "CAB00", "CHO00", "CHC00", "AST00", "ALT00", "CK000")
factors <- subset(cfa2_week0, select=(clusters))
factors <- as.data.frame(cor(factors, use="pairwise.complete.obs"))
Values <- kable(factors[1:4])
Values

```

I would like to see if other variables (not included in the EFA) are correlated to TLAMS52
```{r}
library(knitr)
LeftOut <- c("HGB00","HCT00","RBC00","STP00","ALB00","CAB00","CHO00",
             "AST00","CK000","ALT00","BUN00","BC900","BUA00","P0400",
             "MCV00","MCH00", "CHC00")



LeftOutVars <- cfa2_week0[ , !(names(cfa2_week0) %in% LeftOut)]

CorLeftOut <- as.data.frame(cor(LeftOutVars, use="pairwise.complete.obs"))
CorLeftOut <- kable(CorLeftOut[1])
CorLeftOut
```


